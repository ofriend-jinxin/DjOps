{% extends 'base.html' %}
{% block content %}
    <div class="layui-collapse" lay-filter="test">
        <div class="layui-colla-item">
            <h2 class="layui-colla-title">展开搜索</h2>
            <div class="layui-colla-content">
                <div class="demoTable">
                    IP：
                    <div class="layui-inline">
                        <input class="layui-input" id="search_ip" autocomplete="off">
                    </div>

                    SN：
                    <div class="layui-inline">
                        <input class="layui-input" id="search_sn" autocomplete="off">
                    </div>
                    应用：
                    <div class="layui-inline">
                        <input class="layui-input" id="search_app" autocomplete="off">
                    </div>
                    主机名：
                    <div class="layui-inline">
                        <input class="layui-input" id="search_hostname" autocomplete="off">
                    </div>
                    <button class="layui-btn" data-type="reload">搜索</button>
                </div>
            </div>
        </div>
    </div>

    <table class="layui-hide" id="runresult" lay-filter="runresult"></table>


{% endblock content %}

{% block js-content %}
    <script type="text/html" id="toolbarDemo">
        <div class="layui-btn-container">

            <button class="layui-btn layui-btn-sm layui-btn-danger" lay-event="delete">批量删除</button>

        </div>
    </script>

    <script type="text/html" id="barDemo">
        <a class="layui-btn layui-btn-xs" data-method="open" lay-event="open">查看结果</a>
        <a class="layui-btn layui-btn-xs" data-method="rerun" lay-event="rerun">重新执行</a>
    </script>
    <script>

        layui.use('table', function () {
            var table = layui.table, layer = layui.layer, element = layui.element, util = layui.util, $ = layui.$;
            table.render({
                elem: '#runresult'
                , url: '/api/results/'
                , toolbar: '#toolbarDemo' //开启头部工具栏，并为其绑定左侧模板

                , defaultToolbar: ['filter', 'exports', 'print', { //自定义头部工具栏右侧图标。如无需自定义，去除该参数即可
                    title: '提示'
                    , layEvent: 'LAYTABLE_TIPS'
                    , icon: 'layui-icon-tips'
                }]
                , cols: [[
                    {type: 'checkbox', fixed: 'left', sort: true, id: 'goodsLimitSeqNo'}
                    , {field: 'id', title: 'id', fixed: 'left', unresize: true, width: 60}
                    , {field: 'ip', title: 'IP', width: 300, sort: true}
                    , {field: 'num', title: 'IP数量', width: 120, sort: true}
                    , {field: 'ctype', title: '任务类型', width: 110, sort: true}
                    , {field: 'args', title: '任务参数', sort: true, width: 200,}
                    , {field: 'is_sudo', title: 'sudo', sort: true, width: 100,}
                    , {field: 'ctime', title: '任务更新时间', sort: true, width: 200,}
                    , {field: 'result_txt', title: '任务结果', sort: true, width: 300,}
                    , {fixed: 'right', title: '操作', toolbar: '#barDemo', width: 200}
                ]]
                , initSort: {
                    field: 'ctime',
                    type: 'desc'
                }
                , page: true
                , id: 'tabReload'
            });
            //监听行工具事件
            table.on('tool(runresult)', function (obj) {
                    var data = obj.data;
                    if (obj.event == 'open') {
                        var url = '/openresult/?id=' + data.id
                        layer.open({
                            type: 2,
                            title: "执行结果",
                            shadeClose: true,
                            maxmin: true,
                            area: ['90%', '90%'],
                            content: [url, 'on'],
                            btn: ['关闭'],
                        })

                    } else if (obj.event == 'rerun') {
                        var boxmsg = '重新执行'
                        var url = "/rerun/"
                        layer.confirm(boxmsg, {
                            btn: ['确认', '取消']
                        }, function () {
                            // 按钮1的事件
                            $.ajax({
                                type: "POST",
                                url: url,
                                async: false,
                                data: {"id": data.id},
                                success: function (resdata) {
                                    if (resdata.code == 0) {
                                        layer.msg(resdata.msg, {icon: 1});
                                        console.log(resdata.log);
                                        window.setTimeout("javascript:location.href='/runresult/'", 1000);
                                    } else {
                                        layer.msg(resdata.msg, {icon: 2});
                                        console.log(resdata.log);
                                    }
                                }
                            });
                            return false;
                        }, function (index) {
                            // 按钮2的事件
                            layer.close(index);
                        });
                    }

                }
            );


            table.on('toolbar(runresult)', function (obj) {
                var checkStatus = table.checkStatus(obj.config.id);
                var data = checkStatus.data;
                var idlist = ''
                for (var item in data) {
                    idlist += data[item].id + ",";
                }
                switch (obj.event) {
                    case 'delete':
                        if (data.length != 0) {
                            var boxmsg = '确认删除'
                            var url = "/runresult/?delid=" + idlist
                            layer.confirm(boxmsg, {
                                btn: ['确认', '取消']
                            }, function () {
                                // 按钮1的事件
                                layer.msg("确认操作，请耐心等待");
                                $.ajax({
                                    type: "get",
                                    url: url,
                                    async: false,
                                    success: function (resdata) {
                                        if (resdata.code == 0) {
                                            layer.msg(resdata.msg, {icon: 1});
                                            console.log(resdata.log);
                                            window.setTimeout("javascript:location.href='/runresult/'", 1000);
                                        } else {
                                            layer.msg(resdata.msg, {icon: 2});
                                            console.log(resdata.log);
                                        }
                                    }
                                });
                            }, function (index) {
                                // 按钮2的事件
                                layer.close(index);
                            });
                        } else {
                            layer.msg('未选中任何主机');
                        }
                        break;
                    //自定义头工具栏右侧图标 - 提示
                    case
                    'LAYTABLE_TIPS'
                    :
                        layer.alert('这是工具栏右侧自定义的一个图标按钮');
                }

            })
            var active = {
                reload: function () {
                    var search_ip = $('#search_ip');
                    var search_sn = $('#search_sn');
                    var search_app = $('#search_app');
                    var search_hostname = $('#search_hostname');

                    table.reload('tabReload', {
                        page: {
                            curr: 1
                        }
                        , where: {
                            ip: search_ip.val(),
                            sn: search_sn.val(),
                            app: search_app.val(),
                            hostname: search_hostname.val(),

                        }
                    });
                }
            };
            $('.demoTable .layui-btn').on('click', function () {
                var type = $(this).data('type');
                active[type] ? active[type].call(this) : '';
            });
        })

    </script>

{% endblock js-content %}

